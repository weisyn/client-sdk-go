# Client - æ ¸å¿ƒå®¢æˆ·ç«¯å±‚

**ç‰ˆæœ¬**: 1.0.0-alpha  
**çŠ¶æ€**: âœ… æ ¸å¿ƒåŠŸèƒ½å·²å®Œæˆ  
**æœ€åæ›´æ–°**: 2025-01-23

---

## ğŸ“‹ æ¦‚è¿°

Client æ¨¡å—æ˜¯ SDK çš„æ ¸å¿ƒé€šä¿¡å±‚ï¼Œæä¾›ä¸ WES èŠ‚ç‚¹äº¤äº’çš„ç»Ÿä¸€æ¥å£ã€‚æ”¯æŒ HTTPã€gRPCã€WebSocket ä¸‰ç§ä¼ è¾“åè®®ï¼Œæ‰€æœ‰ä¸šåŠ¡æœåŠ¡éƒ½é€šè¿‡ Client æ¥å£ä¸èŠ‚ç‚¹é€šä¿¡ã€‚

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### å®¢æˆ·ç«¯æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Client æ¨¡å—æ¶æ„                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Client æ¥å£     â”‚  (client.Client)
â”‚                  â”‚
â”‚  â€¢ Call()        â”‚
â”‚  â€¢ SendRawTransaction() â”‚
â”‚  â€¢ Subscribe()   â”‚
â”‚  â€¢ Close()       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†‘
        â”‚ å®ç°
        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              â”‚               â”‚
â”‚  HTTP        â”‚  gRPC         â”‚  WebSocket
â”‚  Client      â”‚  Client       â”‚  Client
â”‚              â”‚               â”‚
â”‚  âœ… å®Œæˆ     â”‚  âœ… æ¡†æ¶å®Œæˆ  â”‚  âœ… å®Œæˆ
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WES èŠ‚ç‚¹        â”‚
â”‚                  â”‚
â”‚  JSON-RPC API    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åè®®é€‰æ‹©

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           åè®®é€‰æ‹©æŒ‡å—                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

HTTP (ProtocolHTTP)
  â”œâ”€> âœ… æœ€å¸¸ç”¨
  â”œâ”€> âœ… ç®€å•å¯é 
  â”œâ”€> âœ… æ”¯æŒæ‰€æœ‰ JSON-RPC æ–¹æ³•
  â””â”€> âŒ ä¸æ”¯æŒäº‹ä»¶è®¢é˜…

gRPC (ProtocolGRPC)
  â”œâ”€> âœ… é«˜æ€§èƒ½
  â”œâ”€> âœ… ç±»å‹å®‰å…¨
  â”œâ”€> âš ï¸ éœ€è¦èŠ‚ç‚¹æä¾› gRPC æœåŠ¡
  â””â”€> ğŸ“‹ å½“å‰ä¸ºæ¡†æ¶å®ç°

WebSocket (ProtocolWebSocket)
  â”œâ”€> âœ… æ”¯æŒäº‹ä»¶è®¢é˜…
  â”œâ”€> âœ… å®æ—¶é€šä¿¡
  â”œâ”€> âœ… åŒå‘é€šä¿¡
  â””â”€> âš ï¸ è¿æ¥ç®¡ç†å¤æ‚
```

### è¯·æ±‚/å“åº”æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            HTTP å®¢æˆ·ç«¯è¯·æ±‚æµç¨‹                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åº”ç”¨å±‚
  â”‚
  â”œâ”€> client.Call(ctx, "wes_getBalance", params)
  â”‚
  â†“
HTTP Client (http.go)
  â”‚
  â”œâ”€> 1. æ„å»º JSON-RPC è¯·æ±‚
  â”‚   {
  â”‚     "jsonrpc": "2.0",
  â”‚     "method": "wes_getBalance",
  â”‚     "params": [...],
  â”‚     "id": 1
  â”‚   }
  â”‚
  â”œâ”€> 2. HTTP POST è¯·æ±‚
  â”‚   POST / HTTP/1.1
  â”‚   Content-Type: application/json
  â”‚
  â”œâ”€> 3. ç­‰å¾…å“åº”
  â”‚   {
  â”‚     "jsonrpc": "2.0",
  â”‚     "result": {...},
  â”‚     "id": 1
  â”‚   }
  â”‚
  â””â”€> 4. è§£æå¹¶è¿”å›ç»“æœ
      â”‚
      â†“
åº”ç”¨å±‚
```

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         WebSocket å®¢æˆ·ç«¯è¯·æ±‚æµç¨‹                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åº”ç”¨å±‚
  â”‚
  â”œâ”€> client.Call(ctx, "wes_getBalance", params)
  â”‚
  â†“
WebSocket Client (websocket.go)
  â”‚
  â”œâ”€> 1. ç”Ÿæˆè¯·æ±‚ ID
  â”œâ”€> 2. åˆ›å»ºå“åº”é€šé“
  â”œâ”€> 3. å‘é€ JSON-RPC è¯·æ±‚ (WebSocket)
  â”œâ”€> 4. ç­‰å¾…å“åº”ï¼ˆé€šè¿‡é€šé“ï¼‰
  â””â”€> 5. è¿”å›ç»“æœ
      â”‚
      â†“
åº”ç”¨å±‚

åå°: readLoop()
  â”œâ”€> æŒç»­è¯»å– WebSocket æ¶ˆæ¯
  â”œâ”€> æ ¹æ® ID åŒ¹é…è¯·æ±‚
  â””â”€> å‘é€åˆ°å¯¹åº”é€šé“
```

---

## ğŸ”§ æ ¸å¿ƒæ¥å£

### Client æ¥å£

```go
type Client interface {
    // Call è°ƒç”¨ JSON-RPC æ–¹æ³•
    // å‚æ•°:
    //   - ctx: ä¸Šä¸‹æ–‡
    //   - method: JSON-RPC æ–¹æ³•åï¼ˆå¦‚ "wes_getBalance"ï¼‰
    //   - params: æ–¹æ³•å‚æ•°ï¼ˆæ•°ç»„æˆ–å¯¹è±¡ï¼‰
    // è¿”å›:
    //   - interface{}: è§£æåçš„ç»“æœ
    //   - error: é”™è¯¯ä¿¡æ¯
    Call(ctx context.Context, method string, params interface{}) (interface{}, error)
    
    // SendRawTransaction å‘é€å·²ç­¾åçš„åŸå§‹äº¤æ˜“
    // å‚æ•°:
    //   - ctx: ä¸Šä¸‹æ–‡
    //   - signedTxHex: å·²ç­¾åäº¤æ˜“çš„åå…­è¿›åˆ¶å­—ç¬¦ä¸²ï¼ˆå¸¦ 0x å‰ç¼€ï¼‰
    // è¿”å›:
    //   - *SendTxResult: äº¤æ˜“æäº¤ç»“æœ
    //   - error: é”™è¯¯ä¿¡æ¯
    SendRawTransaction(ctx context.Context, signedTxHex string) (*SendTxResult, error)
    
    // Subscribe è®¢é˜…äº‹ä»¶ï¼ˆWebSocket æ”¯æŒï¼‰
    // å‚æ•°:
    //   - ctx: ä¸Šä¸‹æ–‡
    //   - filter: äº‹ä»¶è¿‡æ»¤å™¨
    // è¿”å›:
    //   - <-chan *Event: äº‹ä»¶é€šé“
    //   - error: é”™è¯¯ä¿¡æ¯
    Subscribe(ctx context.Context, filter *EventFilter) (<-chan *Event, error)
    
    // Close å…³é—­è¿æ¥
    Close() error
}
```

---

## ğŸ“¦ å®ç°è¯¦æƒ…

### HTTP Client âœ…

**æ–‡ä»¶**: `client/http.go`

**ç‰¹ç‚¹**:
- âœ… å®Œæ•´çš„ JSON-RPC 2.0 æ”¯æŒ
- âœ… è¯·æ±‚/å“åº”åºåˆ—åŒ–
- âœ… é”™è¯¯å¤„ç†
- âœ… è¶…æ—¶æ§åˆ¶
- âœ… è¿æ¥æ± ç®¡ç†

**ä½¿ç”¨ç¤ºä¾‹**:
```go
config := &client.Config{
    Endpoint: "http://localhost:8545",
    Protocol: client.ProtocolHTTP,
    Timeout:  30,
}
httpClient, err := client.NewClient(config)
```

### gRPC Client âœ…

**æ–‡ä»¶**: `client/grpc.go`

**ç‰¹ç‚¹**:
- âœ… åŸºç¡€æ¡†æ¶å®Œæˆ
- âš ï¸ ç­‰å¾…èŠ‚ç‚¹æä¾› gRPC æœåŠ¡æ¥å£
- ğŸ“‹ å½“å‰è¿”å›æç¤ºä¿¡æ¯

**ä½¿ç”¨ç¤ºä¾‹**:
```go
config := &client.Config{
    Endpoint: "localhost:9090",
    Protocol: client.ProtocolGRPC,
}
grpcClient, err := client.NewClient(config)
```

**æ³¨æ„**: å¦‚æœèŠ‚ç‚¹åªæä¾› JSON-RPC over HTTPï¼ŒgRPC å®¢æˆ·ç«¯éœ€è¦é€šè¿‡ HTTP é€‚é…å™¨å®ç°ã€‚

### WebSocket Client âœ…

**æ–‡ä»¶**: `client/websocket.go`

**ç‰¹ç‚¹**:
- âœ… å®Œæ•´çš„ JSON-RPC 2.0 over WebSocket æ”¯æŒ
- âœ… å¼‚æ­¥è¯·æ±‚/å“åº”å¤„ç†
- âœ… äº‹ä»¶è®¢é˜…æ”¯æŒ
- âœ… è‡ªåŠ¨è¿æ¥ç®¡ç†
- âœ… é”™è¯¯æ¢å¤

**ä½¿ç”¨ç¤ºä¾‹**:
```go
config := &client.Config{
    Endpoint: "ws://localhost:8081",
    Protocol: client.ProtocolWebSocket,
}
wsClient, err := client.NewClient(config)
defer wsClient.Close()

// è®¢é˜…äº‹ä»¶
events, err := wsClient.Subscribe(ctx, &client.EventFilter{
    Topics: []string{"Transfer"},
})
```

---

## ğŸ”„ è¯·æ±‚/å“åº”æ ¼å¼

### JSON-RPC è¯·æ±‚æ ¼å¼

```json
{
  "jsonrpc": "2.0",
  "method": "wes_getBalance",
  "params": ["CUQ3g6P5WmFN289pPn7AAhnQ3T2cZRv2BR"],
  "id": 1
}
```

### JSON-RPC å“åº”æ ¼å¼

**æˆåŠŸå“åº”**:
```json
{
  "jsonrpc": "2.0",
  "result": {
    "balance": "0x1234",
    "height": "0x5678"
  },
  "id": 1
}
```

**é”™è¯¯å“åº”**:
```json
{
  "jsonrpc": "2.0",
  "error": {
    "code": -32602,
    "message": "Invalid params",
    "data": "address format error"
  },
  "id": 1
}
```

---

## ğŸ¯ ä½¿ç”¨åœºæ™¯

### HTTP Client

**é€‚ç”¨åœºæ™¯**:
- âœ… å¸¸è§„ API è°ƒç”¨
- âœ… æŸ¥è¯¢æ“ä½œ
- âœ… äº¤æ˜“æäº¤
- âœ… ç®€å•åº”ç”¨

**ç¤ºä¾‹**:
```go
// æŸ¥è¯¢ä½™é¢
result, err := client.Call(ctx, "wes_getBalance", []interface{}{address})

// æäº¤äº¤æ˜“
result, err := client.SendRawTransaction(ctx, signedTxHex)
```

### WebSocket Client

**é€‚ç”¨åœºæ™¯**:
- âœ… äº‹ä»¶è®¢é˜…
- âœ… å®æ—¶ç›‘æ§
- âœ… éœ€è¦åŒå‘é€šä¿¡çš„åº”ç”¨

**ç¤ºä¾‹**:
```go
// è®¢é˜…è½¬è´¦äº‹ä»¶
events, err := wsClient.Subscribe(ctx, &client.EventFilter{
    Topics: []string{"Transfer"},
    From:   fromAddr,
})

for event := range events {
    fmt.Printf("æ”¶åˆ°äº‹ä»¶: %s\n", event.Topic)
}
```

### gRPC Client

**é€‚ç”¨åœºæ™¯**:
- âœ… é«˜æ€§èƒ½åº”ç”¨
- âœ… ç±»å‹å®‰å…¨è¦æ±‚é«˜
- âœ… èŠ‚ç‚¹æä¾› gRPC æœåŠ¡

**æ³¨æ„**: å½“å‰ä¸ºæ¡†æ¶å®ç°ï¼Œç­‰å¾…èŠ‚ç‚¹ gRPC æœåŠ¡æ¥å£ã€‚

---

## ğŸ”’ å®‰å…¨è€ƒè™‘

### 1. TLS æ”¯æŒ

```go
config := &client.Config{
    Endpoint: "https://node.example.com",
    Protocol: client.ProtocolHTTP,
    TLS: &client.TLSConfig{
        CAFile: "/path/to/ca.crt",
        // æˆ–
        Insecure: false, // ç”Ÿäº§ç¯å¢ƒåº”è®¾ä¸º false
    },
}
```

### 2. è¶…æ—¶æ§åˆ¶

```go
config := &client.Config{
    Endpoint: "http://localhost:8545",
    Timeout:  30, // ç§’
}
```

### 3. è¿æ¥ç®¡ç†

- âœ… HTTP: è¿æ¥æ± ç®¡ç†
- âœ… WebSocket: è‡ªåŠ¨é‡è¿ï¼ˆæœªæ¥ï¼‰
- âœ… gRPC: è¿æ¥å¤ç”¨

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ä¸» README](../README.md) - SDK æ€»ä½“æ–‡æ¡£
- [Services æ–‡æ¡£](../services/README.md) - ä¸šåŠ¡æœåŠ¡æ–‡æ¡£
- [Wallet æ–‡æ¡£](../wallet/README.md) - é’±åŒ…åŠŸèƒ½æ–‡æ¡£

---

**æœ€åæ›´æ–°**: 2025-01-23  
**ç»´æŠ¤è€…**: WES Core Team

